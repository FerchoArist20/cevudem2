name: Docker

on:
  push:
    branches: main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    - name: Instalar dependencias
      if: false
      run: npm install
    
    - name: Build and push images
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      run: |
        docker-compose build
        docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        for service in $(docker-compose config --services); do
          image_name=$(docker-compose images -q $service)
          image_tag=$(docker inspect --format='{{index .Config.Labels "com.docker.compose.version"}}' $image_name)
          repo_name=$(echo $service | tr '[:upper:]' '[:lower:]')
          docker tag $image_name $DOCKER_USERNAME/$repo_name:$image_tag
          docker push $DOCKER_USERNAME/$repo_name:$image_tag
        done